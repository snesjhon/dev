---
import BaseLayout from './BaseLayout.astro';
import ImageCarousel from '../components/ImageCarousel.astro';
import type { WorkItem } from '../content/data/work';
import { careerTimeline } from '../content/data/career-timeline';

interface Props {
  item: WorkItem;
}

const { item } = Astro.props;

const careerEntry = careerTimeline
  .flatMap(period => period.entries)
  .find(entry => entry.company.toLowerCase().includes(item.company.toLowerCase().split(' ')[0]));

const badgeInfo: Record<string, { logo: string; color: string; logoColor?: string }> = {
  'JavaScript': { logo: 'javascript', color: 'F7DF1E', logoColor: 'black' },
  'TypeScript': { logo: 'typescript', color: '3178C6' },
  'React': { logo: 'react', color: '61DAFB', logoColor: 'black' },
  'Python': { logo: 'python', color: '3776AB' },
  'Redux': { logo: 'redux', color: '764ABC' },
  'Wordpress': { logo: 'wordpress', color: '21759B' },
  'D3.js': { logo: 'd3dotjs', color: 'F9A03C', logoColor: 'black' },
  'Webpack': { logo: 'webpack', color: '8DD6F9', logoColor: 'black' },
  'React Virtualized': { logo: 'react', color: '61DAFB', logoColor: 'black' },
  'GraphQL': { logo: 'graphql', color: 'E10098' },
  'Ruby on Rails': { logo: 'rubyonrails', color: 'D30001' },
  'Playwright': { logo: 'playwright', color: '2EAD33' },
  'Chromatic': { logo: 'chromatic', color: 'FC521F' },
  'GitHub Actions': { logo: 'githubactions', color: '2088FF' },
};

const toBadgeSrc = (tech: string) => {
  const info = badgeInfo[tech];
  const logoColor = info?.logoColor ?? 'white';
  return info
    ? `https://img.shields.io/badge/${tech.replace(/ /g, '_')}-${info.color}?style=flat&logo=${info.logo}&logoColor=${logoColor}`
    : `https://img.shields.io/badge/${tech.replace(/ /g, '_')}-grey?style=flat`;
};
---

<BaseLayout>
  <div class="flex flex-col gap-4">
    <a href="/" class="text-xs text-gh-accent-fg hover:underline flex items-center gap-1">
      <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5 8.25 12l7.5-7.5" />
      </svg>
      Back to portfolio
    </a>

    <div class="bg-gh-canvas-default border border-gh-border-default rounded-md overflow-hidden">
      <div class="p-4 lg:p-8">
        <h1 class="text-xl font-semibold text-gh-fg-default mb-1">{item.company}</h1>
        <div class="flex items-center gap-2 mb-2">
          <p class="text-sm text-gh-fg-muted">{item.title}</p>
          <span class="text-xs text-gh-fg-muted border border-gh-border-default rounded-full px-2 py-0.5">{item.year}</span>
        </div>
        <div class="flex flex-wrap gap-3 text-sm text-gh-accent-fg mb-4">
          {item.tags.map(tag => (
            <span>{tag}</span>
          ))}
        </div>
        <p class="text-sm text-gh-fg-default leading-relaxed">{item.description}</p>
      </div>
    </div>


  <h2 class="text-xl text-gh-fg-default mt-2">What I did</h2>
    {careerEntry && careerEntry.achievements.length > 0 && (
      <div class="bg-gh-canvas-default border border-gh-border-default rounded-md overflow-hidden">
        <div class="p-4 lg:p-8">
          <div class="flex flex-col gap-4">
            {careerEntry.achievements.map(achievement => (
              <div class="border-gh-border-default">
                <h3 class="text-sm font-semibold text-gh-fg-default">{achievement.title}</h3>
                {achievement.description && (
                  <p class="text-sm text-gh-fg-muted mt-1 leading-relaxed">{achievement.description}</p>
                )}
              </div>
            ))}
          </div>
          <div class="flex flex-wrap gap-1.5 mt-4 pt-4 border-t border-gh-border-default">
            {[...new Set(careerEntry.achievements.flatMap(a => a.technologies ?? []))].map(tech => (
              <img src={toBadgeSrc(tech)} alt={tech} class="h-5" />
            ))}
          </div>
        </div>
      </div>
    )}

  <h2 class="text-xl text-gh-fg-default mt-2">Examples</h2>
    <div class="bg-gh-canvas-default border border-gh-border-default rounded-md overflow-hidden">
      <div class="p-4 lg:p-8">
        <ImageCarousel images={item.images} alt={item.company} />
      </div>
    </div>
  </div>
</BaseLayout>
